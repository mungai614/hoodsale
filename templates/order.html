<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Orders - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="admin.html">ClothingStore Admin</a>
    <a class="btn btn-outline-secondary ms-auto" href="admin.html">← Back to Dashboard</a>
  </div>
</nav>

<div class="container my-5">
  <h2 class="mb-4">Customer Orders</h2>

  <div id="orders-container">
    <!-- Orders will load here -->
  </div>
</div>
<script>
  // Redirect if not logged in or not an admin
  const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));

  if (!loggedInUser || loggedInUser.email !== "admin@example.com") {
    alert("Access denied. Admins only.");
    window.location.href = "login.html";
  }
</script>

<script>
  let orders = JSON.parse(localStorage.getItem("orders")) || [];
  const container = document.getElementById("orders-container");

  if (orders.length === 0) {
    container.innerHTML = "<div class='alert alert-warning'>No orders yet.</div>";
  } else {
    orders.reverse().forEach(order => {
      // If no status, default to Pending
      if (!order.status) {
        order.status = "Pending";
      }

      const orderDiv = document.createElement("div");
      orderDiv.className = "card mb-4 shadow-sm";

      let itemsHtml = "";
      order.items.forEach(item => {
        const size = item.size || "—";
        const color = item.color || "—";
        itemsHtml += `<li>${item.name} (${size}, ${color}) × ${item.quantity} - $${(item.price * item.quantity).toFixed(2)}</li>`;
      });

      // Create unique dropdown ID for status control
      const statusSelectId = `status-${order.id}`;

      orderDiv.innerHTML = `
        <div class="card-body">
          <h5 class="card-title">Order #ORD-${order.id}</h5>
          <p><strong>Customer:</strong> ${order.user}</p>
          <p><strong>Date:</strong> ${order.date}</p>
          <ul class="mb-2">${itemsHtml}</ul>
          <p><strong>Total:</strong> $${order.total}</p>

          <div class="mt-3">
            <label for="${statusSelectId}" class="form-label"><strong>Status:</strong></label>
            <select class="form-select w-auto d-inline-block" id="${statusSelectId}" data-id="${order.id}">
              <option value="Pending" ${order.status === "Pending" ? "selected" : ""}>Pending</option>
              <option value="Shipped" ${order.status === "Shipped" ? "selected" : ""}>Shipped</option>
              <option value="Delivered" ${order.status === "Delivered" ? "selected" : ""}>Delivered</option>
            </select>
          </div>
        </div>
      `;

      container.appendChild(orderDiv);

      // Attach event listener to the status dropdown
      setTimeout(() => {
        const select = document.getElementById(statusSelectId);
        select.addEventListener("change", (e) => {
          const updatedStatus = e.target.value;
          const orderId = parseInt(e.target.getAttribute("data-id"));
          const orderToUpdate = orders.find(o => o.id === orderId);
          if (orderToUpdate) {
            orderToUpdate.status = updatedStatus;
            localStorage.setItem("orders", JSON.stringify(orders));
            alert(`Status updated to "${updatedStatus}"`);
          }
        });
      }, 0);
    });
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
